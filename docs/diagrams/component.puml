@startuml Componentes_API_VM
title Diagrama de Componentes - API VM Builder + Abstract Factory

node "Cliente (Swagger/HTTP)" as Client
node "FastAPI App" as FastAPI {
  [API /vm] as VMApi
  [API /cloud/infrastructure] as InfraApi
}

component "VMService" as VMService
component "CloudResourceManager" as CRM
component "Factory Provider" as FactoryProvider
component "Abstract Factories" as Factories {
  [AWSCloudFactory]
  [AzureCloudFactory]
  [GCPCloudFactory]
  [OracleCloudFactory]
  [OnPremiseCloudFactory]
}

package "Builder Pattern" as BuilderPkg {
  component "VMTierDirector" as Director
  component "VMBuilder (iface)" as VMBuilder
  component "Builders Concretos" as BuildersC {
    [AWSVMBuilder]
    [AzureVMBuilder]
    [GCPVMBuilder]
    [OnPremVMBuilder]
    [OracleVMBuilder]
  }
}

database "VMRepository (memoria)" as Repo
component "Logger (audit_log)" as Logger

Client --> VMApi : POST /vm/build\nPOST /vm/create\nPUT/DELETE/GET
Client --> InfraApi : POST /cloud/infrastructure/create

VMApi --> VMService
InfraApi --> VMService

VMService --> Director : build_vm()
VMService --> VMBuilder : selecciona builder por proveedor
Director --> BuildersC : orquesta set_* y build()

VMService --> FactoryProvider : create_cloud_factory()
FactoryProvider --> Factories
VMService --> Factories : create_virtual_machine(...)
VMService --> CRM : create_infrastructure(...)
CRM --> Factories : create_*(...)

VMService --> Repo : save()
VMService --> Logger : audit_log
CRM --> Logger : audit_log

@enduml
